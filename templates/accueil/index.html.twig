{% extends 'base.html.twig' %}

{% block title %}Accueil - Cooksy{% endblock %}

{% block body %}

<link 
  rel="preload" 
  href="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=1600&fm=webp&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
  as="image"
  fetchpriority="high"
>
<!-- Tailwind CSS CDN (Layout için Gerekli) ve Font Awesome (İkonlar için Gerekli) -->

<script src="https://cdn.tailwindcss.com"></script>


<style>
.background-food {
    /* W=1600 ve fm=webp ile optimize edilmiş URL */
    background-image: url('https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=1600&fm=webp&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
  position: relative; /* ÖNEMLİ */
}

.blur-overlay {
  backdrop-filter: blur(6px);
  background-color: rgba(0, 0, 0, 0.4);
  z-index: 0;
}

.search-input::-webkit-search-cancel-button {
        -webkit-appearance: none;
        appearance: none;
        /* Boyutu artırıyoruz (W-7 H-7 SVG ile eşleşecek şekilde) */
        width: 1.75rem; 
        height: 1.75rem;
        /* 'x' işaretini daha belirgin ve beyaz yapıyoruz */
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>') no-repeat center center;
        /* Butona tıklanabilirliği artırmak için padding veriyoruz */
        padding: 0;
        cursor: pointer;
        opacity: 0.8; 
        transition: opacity 0.2s;
    }

    .search-input::-webkit-search-cancel-button:hover {
        opacity: 1;
    }


</style>

<header class="bg-[#2e2e2e] shadow-md">
    <div class="container mx-auto flex items-center justify-between p-4 flex-wrap">
        <div class="flex-shrink-0">
            <a href="{{ path('app_accueil') }}">
            <img src="{{ asset('images/cooksy_logo.png') }}" alt="Cooksy Logo" class="h-20 w-auto">
            </a>
        </div>
        <div class="relative flex-grow mx-auto max-w-lg w-full mt-4 mb-2">
            <form action="{{ path('app_recette_index') }}" method="GET" class="relative flex-grow mx-auto max-w-lg order-last md:order-none w-full md:w-auto mt-4 md:mt-0">
                <input type="search" name="q" placeholder="Que faisons-nous aujourd'hui ?" value="{{ app.request.query.get('q') }}" 
                        class="w-full pl-16 pr-10 py-2 text-white border border-gray-600 
                        rounded-full focus:outline-none focus:ring-2 focus:ring-orange-500 
                        transition duration-300 placeholder-white search-input">
                    <button type="submit" class="absolute left-0 top-10 transform -translate-y-1/2 ml-4 text-white z-10">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
            </form>

        </div>
    <div class="flex space-x-2 md:space-x-4">
        {# Kullanıcı giriş yaptıysa, profil avatarını ve çıkış yap bağlantısını göster #}
        {% if is_granted('IS_AUTHENTICATED_FULLY') %}
            <div class="user-info flex items-center space-x-2">
                        <a href="{{ path('app_profil') }}" class="flex-col flex items-center text-gray-200 hover:text-orange-600 font-medium">
                        {% if app.user.image %}
                            <img src="{{ asset('uploads/' ~ app.user.image) }}" alt="Profil Resmi" class="profile-avatar w-[76px] h-[76px]">
                        {% else %}
                            <img src="https://placehold.co/32x32/E0E0E0/FFFFFF?text=P" alt="Varsayılan Profil Resmi" class="profile-avatar w-[76px] h-[76px] border-2 border-orange-500">
                        {% endif %}
                        
                        <span>{{ app.user.nom }}</span>
                        </a>

                        <div class="flex flex-col items-center space-y-4 ml-6 relative">
                        {# ADMIN PANEL LİNKİ — sadece adminlere görünür #}
                        {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('app_admin_index') }}" class="relative group">
                                    <i class="fa-solid fa-gear text-blue-500 text-3xl"></i>
                                    <span class="absolute top-1/2 left-[-270px] translate-x-1/2 mt-2 px-2 py-1 bg-yellow-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-50 whitespace-nowrap shadow-md">
                                        Panneau d’administration
                                    </span>
                                </a>
                            {% endif %}

                        <a href="{{ path('app_logout') }}" class="relative group">
                            
                            <i class="fa-solid fa-right-from-bracket text-red-500 text-3xl"></i>
                            <span class="absolute left-[10px] top-1/2 -translate-x-1/2 mt-2 px-2 py-1 bg-yellow-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-50 whitespace-nowrap shadow-md">Se déconnecter</span>
                        </a>
                    </div>
        {# Kullanıcı giriş yapmadıysa, giriş ve kayıt linklerini göster #}
        {% else %}
            <a href="{{ path('app_login') }}" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300 transform hover:scale-105 shadow-md">Se connecter</a>
            <a href="{{ path('app_register') }}" class="bg-orange-100 text-orange-600 font-semibold py-2 px-4 rounded-full border border-orange-500 hover:bg-orange-200 transition duration-300 transform hover:scale-105 shadow-md">S'inscrire</a>
        {% endif %}
    </div>
</div>

</header>
<!-- Yeni Menü -->
<nav class="bg-gray-300 shadow-sm p-4 relative">
        <div class="container mx-auto flex justify-end items-center">
            <div class="hidden md:!flex space-x-6 justify-center items-center w-full">
                <a href="{{ path('app_recette_index') }}" class="{% if app.request.attributes.get('_route') == 'app_recette_index' %}text-orange-600{% else %}text-gray-700 hover:text-orange-600{% endif %} font-semibold transition duration-300">Recettes</a>
                <a href="{{ path('app_cuisines_index') }}" class="{% if app.request.attributes.get('_route') == 'app_cuisines_index' %}text-orange-600{% else %}text-gray-700 hover:text-orange-600{% endif %} font-semibold transition duration-300">Cuisines</a>
                <a href="{{ path('app_astuces_index') }}" class="{% if app.request.attributes.get('_route') == 'app_astuces_index' %}text-orange-600{% else %}text-gray-700 hover:text-orange-600{% endif %} font-semibold transition duration-300">Astuces</a>
                <a href="{{ path('app_about_index') }}" class="{% if app.request.attributes.get('_route') == 'app_about_index' %}text-orange-600{% else %}text-gray-700 hover:text-orange-600{% endif %} font-semibold transition duration-300">À propos</a>
                <a href="{{ path('app_contact_index') }}" class="{% if app.request.attributes.get('_route') == 'app_contact_index' %}text-orange-600{% else %}text-gray-700 hover:text-orange-600{% endif %} font-semibold transition duration-300">Contact</a>
            </div>

         <!-- Burger Menü Butonu (sadece mobilde) -->
            <div class="relative md:hidden ml-auto group">
                <button id="burger-btn" class="md:hidden ml-auto text-gray-700 text-2xl focus:outline-none cursor-pointer">
                    <i class="fas fa-bars"></i>
                </button>
    

    <!-- Mobile Menü: Konumlandırma sorununu gidermek için bu div'i ana nav div'inin dışına taşıdık. -->
                <div id="mobile-menu" class="hidden group-hover:flex absolute right-0 top-full mt-2 bg-white shadow-lg rounded-md flex-col space-y-2 p-3 w-40 z-50">
                    <a href="{{ path('app_recette_index') }}" class="text-gray-700 hover:bg-gray-100 p-2 rounded block">Recettes</a>
                    <a href="{{ path('app_cuisines_index') }}" class="text-gray-700 hover:bg-gray-100 p-2 rounded block">Cuisines</a>
                    <a href="{{ path('app_astuces_index') }}" class="text-gray-700 hover:bg-gray-100 p-2 rounded block">Astuces</a>
                    <a href="{{ path('app_about_index') }}" class="text-gray-700 hover:bg-gray-100 p-2 rounded block">À propos</a>
                    <a href="{{ path('app_contact_index') }}" class="text-gray-700 hover:bg-gray-100 p-2 rounded block">Contact</a>
                </div>
            </div>
        </div>
    </nav>

<!-- Düzeltilmiş Dinamik İstatistikler Paneli -->

<!-- Ana Kapsayıcı: Flu Arka Plan ve Yükseklik Yönetimi -->





<!-- İçerik Kapsayıcısı (Arka planın önüne taşınır) -->
<div class="container mx-auto w-full relative z-10">
   
        <div class="background-food relative w-full min-h-[40vh] md:min-h-[50vh] flex items-center justify-center py-10 md:py-20">
        
     <!-- Blur ve Koyu Katman (İçerik okunurluğu için) -->
<div class="blur-overlay absolute inset-0 w-full h-full"></div>   
        

    <!-- İstatistik Kartları: BU KISIM YANA YANA OLMASINI SAĞLIYOR -->
    <!-- md:grid-cols-3 sınıfı, tablet ve masaüstü ekranlarında 3 sütuna böler -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-3 lg:gap-8">

        <!-- Kart 1: Recettes Publiées -->
        <div class="bg-white/60 p-6 md:p-10 rounded-xl shadow-2xl hover:shadow-indigo-500/50 transition duration-300 transform hover:scale-[1.02] flex flex-col justify-center items-center h-full min-h-[250px] backdrop-blur-sm">
            <div class="text-indigo-600 mb-4">
                <i class="fas fa-utensils text-4xl"></i>
            </div>
            <p id="stat-recipes" class="text-6xl font-bold text-indigo-700 leading-none">0</p>
            <p class="mt-4 text-xl font-medium text-gray-700 text-center">Recettes Publiées</p>
        </div>

        <!-- Kart 2: Membres Actifs -->
        <div class="bg-white/60 p-6 md:p-10 rounded-xl shadow-2xl hover:shadow-emerald-500/50 transition duration-300 transform hover:scale-[1.02] flex flex-col justify-center items-center h-full min-h-[250px] backdrop-blur-sm">
            <div class="text-emerald-600 mb-4">
                <i class="fas fa-users text-4xl"></i>
            </div>
            <p id="stat-users" class="text-6xl font-bold text-emerald-700 leading-none">0</p>
            <p class="mt-4 text-xl font-medium text-gray-700 text-center">Membres Actifs</p>
        </div>

        <!-- Kart 3: Prix de la Plateforme -->
        <div class="bg-white/60 p-6 md:p-10 rounded-xl shadow-2xl hover:shadow-yellow-500/50 transition duration-300 transform hover:scale-[1.02] flex flex-col justify-center items-center h-full min-h-[250px] backdrop-blur-sm">
            <div class="text-yellow-600 mb-4">
                <i class="fas fa-trophy text-4xl"></i>
            </div>
            <p id="stat-awards" class="text-6xl font-bold text-yellow-700 leading-none">0</p>
            <p class="mt-4 text-xl font-medium text-gray-700 text-center">Prix de la Plateforme</p>
        </div>

    </div>

</div>

</div>

<main class="bg-[#ff7043] container mx-auto p-8">

<h2 class="text-3xl text-center font-bold text-gray-800 mb-6">Recettes Populaires</h2>

<div class="flex flex-wrap gap-6 justify-center">
    {% for recette in recettes %}
        <a href="{{ path('app_recette_detail', {'id': recette.id}) }}" 
                class="bg-white rounded shadow transition-transform duration-300 ease-in-out transform hover:scale-105 
                hover:-translate-y-2 hover:shadow-xl cursor-pointer group flex flex-col w-[280px]">

            
            <!-- Resim -->
            <div class="relative w-full h-[172px]">
                {% if recette.image is not null %}
                    <img src="{{ asset('uploads/recettes/' ~ recette.image) }}" 
                        alt="{{ recette.titre }}" 
                        class="w-full h-full object-cover rounded-t">
                {% endif %}

                <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white text-xs font-bold py-1 px-2 rounded">
                    {{ recette.duree }} min
                </div>

                <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white py-1 px-2 rounded flex items-center space-x-1">
                    <i class="fas fa-heart text-red-500"></i>
                    <span class="text-xs font-bold">{{ recette.likes|length }}</span>
                </div>
            </div>

            <!-- Bilgi -->
            <div class="p-2 recette-info flex flex-col gap-1">
                <h3 class="font-bold text-gray-800 text-base">{{ recette.titre }}</h3>
                <div class="flex items-center justify-between">
                <!-- Yazar -->
                <p class="text-sm text-gray-600">par <span class="font-bold">
                        {{ recette.auteur.nom }}
                    </span></p>
                <!-- Yıldızlar -->
                <div class="flex items-center">
                    {# TWIG DEĞİŞKEN TANIMLAMALARI VE HESAPLAMALAR BAŞLANGIÇ #}
                    {% set totalRating = 0 %}
                    {% set ratingCount = 0 %}
                    {% for commentaire in recette.commentaires %}
                    {% if commentaire.note is not null %}
                    {% set totalRating = totalRating + commentaire.note %}
                    {% set ratingCount = ratingCount + 1 %}
                    {% endif %}
                    {% endfor %}
                    {# ORTALAMA DEĞER HESAPLANIYOR (virgülden sonra 1 basamak) #}
                    {% set averageRating = ratingCount > 0 ? (totalRating / ratingCount)|round(1) : 0 %}
                    {# TWIG DEĞİŞKEN TANIMLAMALARI VE HESAPLAMALAR BİTİŞ #}

                    {# 1. YILDIZ GÖRÜNÜMÜ #}
                    <span class="text-yellow-400 text-xs">
                        {% for i in 1..5 %}
                            {% if averageRating >= i %}
                                <i class="fas fa-star"></i> {# Tam yıldız #}
                            {% elseif averageRating > i - 1 and averageRating < i %}
                                <i class="fas fa-star-half-alt"></i> {# Yarım yıldız #}
                            {% else %}
                                <i class="far fa-star text-gray-400"></i> {# Boş yıldız #}
                            {% endif %}
                        {% endfor %}
                    </span>

                    {# 2. YENİ EKLENEN OYLAMA BİLGİSİ #}
                    {# Örnek: 4.5 / 5 (12 votes) #}
                    <span class="text-gray-600 text-xs font-semibold ml-2">
                        {# Ortalama Puan / Maksimum Puan #}
                        {{ averageRating|number_format(1, ',', '.') }} / 5 
                        
                        {# Oy Sayısı #}
                        <span class="text-gray-500 font-normal">
                            ({{ ratingCount }} vote{{ ratingCount > 1 ? 's' : '' }})
                        </span>
                    </span>

</div>
</div>

            </div>
        </a>
    {% endfor %}
</div>

</main>

<footer class="bg-[#2e2e2e] text-white py-8 mt-10">
<div class="container mx-auto px-4">
<!-- Menü -->
    <div class="flex justify-center space-x-4 mb-6">
            <a href="{{ path('app_recette_index') }}" class="hover:text-orange-500 transition duration-300">Recettes</a>
            <a href="{{ path('app_cuisines_index') }}" class="hover:text-orange-500 transition duration-300">Cuisines</a>
            <a href="{{ path('app_astuces_index') }}" class="hover:text-orange-500 transition duration-300">Astuces</a>
            <a href="{{ path('app_about_index') }}" class="hover:text-orange-500 transition duration-300">À propos</a>
            <a href="{{ path('app_contact_index') }}" class="hover:text-orange-500 transition duration-300">Contact</a>
        </div>

    <hr class="border-gray-700 mb-6">

    <!-- Logo, Slogan ve Sosyal Medya İkonları -->
    <div class="flex md:flex-row items-center justify-between mb-6">
        <div class="flex-1 text-center md:text-left">
            <img src="{{ asset('images/cooksy_logo.png') }}" alt="Cooksy Logo" class="h-16 mx-auto md:mx-0">
            <p class="text-sm mt-2 text-gray-400">Cooksy — Partagez vos recettes préférées 🍲</p>
        </div>
        <div class="flex-1 flex justify-center md:justify-end space-x-4 mt-4 md:mt-0">
            <a href="https://www.facebook.com" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-orange-500 transition duration-300">
                <i class="fab fa-facebook-f text-2xl"></i>
            </a>
            <a href="https://www.instagram.com" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-orange-500 transition duration-300">
                <i class="fab fa-instagram text-2xl"></i>
            </a>
            <a href="https://www.youtube.com" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-orange-500 transition duration-300">
                <i class="fab fa-youtube text-2xl"></i>
            </a>
            <a href="https://www.tiktok.com" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-orange-500 transition duration-300">
                <i class="fab fa-tiktok text-2xl"></i>
            </a>
        </div>
    </div>

    <!-- Telif Hakkı Metni -->
    <div class="text-center text-gray-500 text-sm">
        © 2025 Cooksy. Tous droits réservés.
    </div>
</div>

</footer>

<!-- Sayaç Animasyonu Scripti (Tüm DOM Yüklendikten Sonra Çalışmalı) -->

<script>
// Hedef istatistikler (Fransızca dilinde sayılar ve süreler)
const statsData = [
{ id: 'stat-recipes', target: 542, duration: 2000 },
{ id: 'stat-users', target: 12500, duration: 2500 },
{ id: 'stat-awards', target: 8, duration: 1500 }
];

function animateCount(element, start, end, duration) {
    let startTime = null;
    
    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        
        // Sayıyı yuvarla ve Fransızca formatında binlik ayırıcı (boşluk) ekle
        const currentValue = Math.floor(progress * (end - start) + start);
        // Hata Düzeltildi: 'fr-FR' artık doğru tırnak işaretleriyle kullanılıyor.
        element.textContent = currentValue.toLocaleString('fr-FR'); 
        
        if (progress < 1) {
            window.requestAnimationFrame(step);
        } else {
            // Hata Düzeltildi: 'fr-FR' artık doğru tırnak işaretleriyle kullanılıyor.
            element.textContent = end.toLocaleString('fr-FR'); 
        }
    }
    
    window.requestAnimationFrame(step);
}

function startAllCounters() {
    // NOT: statsData değişkeninin bu kod bloğunun dışında tanımlandığını varsayıyoruz.
    statsData.forEach(stat => {
        const element = document.getElementById(stat.id);
        if (element) {
            animateCount(element, 0, stat.target, stat.duration);
        }
    });
}

// Sayfa yüklendiğinde veya panel görünür olduğunda saymaya başla
// window.onload yerine DOMContentLoaded kullanıldı (Daha hızlı ve güvenilir)
document.addEventListener('DOMContentLoaded', function() {
    // İstatistik panelinin ana kapsayıcısını seçiyoruz
    // Hata Düzeltildi: '.background-food' doğru tırnak işaretleriyle kullanılıyor.
    const statPanel = document.querySelector('.background-food'); 
    if (!statPanel) return; // Panel yoksa dur

    // Intersection Observer kullanarak sadece kullanıcı paneli gördüğünde animasyonu başlatma
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                startAllCounters();
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1
    });

    observer.observe(statPanel);
});

const burgerBtn = document.getElementById("burger-btn");
const mobileMenu = document.getElementById("mobile-menu");

// Menü aç/kapa
burgerBtn.addEventListener("mouseover", (event) => {
    event.stopPropagation();
    mobileMenu.classList.remove("hidden");
});

document.addEventListener("click", (event) => {
    const isMenuVisible = !mobileMenu.classList.contains("hidden");
    
    if(isMenuVisible && !burgerBtn.contains(event.target) && !mobileMenu.contains(event.target)) {
        mobileMenu.classList.add("hidden");
    }
});

// Ekran genişleyince (md ve üstü) mobil menüyü otomatik kapat
window.addEventListener("resize", () => {
  if (window.innerWidth >= 768) {
    mobileMenu.classList.add("hidden");
  }
});

</script>

{% endblock %}